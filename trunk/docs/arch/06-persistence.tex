\section{Servicios de Persistencia}

Si bien para la persistencia de los datos creamos los manejadores de archivos, es necesario un objeto que se encargue de administrar el acceso y la recuperación de los mismos a un nivel mayor de abstracción, es decir, a nivel de palabras y sonidos.
Es necesario, además, de acuerdo a los requerimientos de entregas posteriores, que su interfaz sea independiente de la implementación de los archivos.
  
\subsection{Requerimientos del servicio de persistencia}

El servicio de persistencia encapsula el manejo de los dos archivos: el de palabras y el del audio. Debe presentar una interfaz que permita agregar palabras con su respectivo audio, consultar si una palabra está registrada y recuperar un audio a partir de su correspondiente palabra.
Decidimos que una vez que la palabra fue registrada, no sólo no se pueda eliminar, sino que además, no se puede modificar su registro de audio. En este caso, el servicio debe informar que no es una acción válida.

\subsection{Implementación del servicio de persistencia}

De acuerdo a los requerimientos mencionados anteriormente, definimos que el servicio de persistencia debe implementar la interfaz \textbf{SoundPersistenceService}.
En particular, para esta entrega, la clase \textbf{SoundPersistenceServiceVariableLengthImpl} lo hace utilizando archivos con registros de longitud variable organizados en bloques.

En la siguiente imágen podemos observar las características de esta interfaz y, posteriormente, analizaremos la implementación:

\begin{figure}[!htp]
	\begin{center}
		\includegraphics[scale=0.45,natwidth=40pt,natheight=20pt]{img/ClassModelSoundService2.JPG}
	\end{center}
	\caption{Diagrama de clases del SoundPersistenceService}
	\label{fig:classSPS1}
\end{figure}
 
\begin{figure}[!htp]
	\begin{center}
		\includegraphics[scale=0.45,natwidth=40pt,natheight=20pt]{img/ClassModelSoundService1.JPG}
	\end{center}
	\caption{Diagrama de clases de implementación de SoundPersistenceService}
	\label{fig:classSPS2}
\end{figure}

\subsubsection{Acceso a los archivos}

De acuerdo al enunciado, existen dos archivos: uno que guarda como registros el par (palabra,offset) y otro que tiene sólamente (datosaudio).
Cada registro está representado por las clases \textbf{RegistroOffsetWord} y \textbf{RegistroInputStream} respectivamente.

Cada uno de estos registros implementa la interfaz Serializable y, por lo tanto, no solo guardan datos sino, además, la información de como serializarse.
Así, al momento de ser creado el archivo, se le pasa como parámetro el serializador correspondiente al tipo de registro que guarda.
Ésto hace que el servicio de persistencia trabaje directamente con objetos serializados y no con cadenas de bytes.

Si bien los archivos tienen registros diferentes, el acceso a ellos es idéntico, y se hace mediante la interfaz \textbf{DynamicAccessor}.Es decir, que se tienen dos referencias del tipo \textbf{DynamicAccessor} a objetos que son instancias de \textbf{VariableLengthFileManager}.

\subsubsection{Inserción de nuevas palabras}

Para la inserción de una palabra, con su respectivo audio, primero se recorre todo el archivo de palabras verificando que no haya sido guardada antes. Si no está, se inserta el audio en el archivo de sonidos, se recupera la dirección en la que ha sido guardado y se agrega el registro (palabra,offset) en el archivo de palabras.
En caso de que la palabra ya exista, y se quiera volver a insertar, independientemente de si el audio es el mismo o no, se lanza una excepción.

\subsubsection{Recuperación de audio}

Para la recuperación de un audio, se recibe como parámetro la palabra y se la busca recorriendo, en forma secuencial, el archivo correspondiente. Una vez que se la encuentra, se toma su offset
y, a partir de él, se recupera el audio accediendo en forma relativa al archivo de sonidos.
Al igual que en la inserción, en caso de que la palabra no esté, se lanza una excepción.
Un tercer método del servicio de persistencia es ver si una palabra está guardada o no. Al igual que antes, se recorre el archivo de palabras y se devuelve el resultado.
